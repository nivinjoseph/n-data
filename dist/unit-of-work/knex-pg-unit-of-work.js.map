{"version":3,"file":"knex-pg-unit-of-work.js","sourceRoot":"","sources":["../../src/unit-of-work/knex-pg-unit-of-work.ts"],"names":[],"mappings":"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","sourcesContent":["import { UnitOfWork } from \"./unit-of-work\";\nimport { DbConnectionFactory } from \"../db-connection-factory/db-connection-factory\";\nimport { given } from \"n-defensive\";\nimport * as Knex from \"knex\";\nimport { InvalidOperationException } from \"n-exception\";\nimport { inject } from \"n-ject\";\n\n\n// public\n@inject(\"DbConnectionFactory\")\nexport class KnexPgUnitOfWork implements UnitOfWork\n{\n    private readonly _dbConnectionFactory: DbConnectionFactory;\n    private _transactionScope: TransactionScope;\n    \n    \n    public constructor(dbConnectionFactory: DbConnectionFactory)\n    {\n        given(dbConnectionFactory, \"dbConnectionFactory\").ensureHasValue();\n        \n        this._dbConnectionFactory = dbConnectionFactory;\n    }\n    \n    public getTransactionScope(): Promise<object>\n    {\n        if (this._transactionScope)\n        {\n            if (this._transactionScope.isCommitted || this._transactionScope.isRolledBack)\n                return Promise.reject(new InvalidOperationException(\"using completed UnitOfWork\"));    \n            return Promise.resolve(this._transactionScope.trx);\n        }\n        \n        let promise = new Promise<object>((resolve, reject) =>\n        {\n            this._dbConnectionFactory.create()\n                .then((knex: Knex) =>\n                {\n                    knex.transaction((trx: Knex.Transaction) =>\n                    {\n                        if (this._transactionScope)\n                        {\n                            trx.rollback();\n                            if (this._transactionScope.isCommitted || this._transactionScope.isRolledBack)\n                                reject(new InvalidOperationException(\"using completed UnitOfWork\")); \n                            else\n                                resolve(this._transactionScope.trx);\n                        }\n                        else\n                        {\n                            this._transactionScope = {\n                                trx: trx,\n                                isCommitted: false,\n                                isRolledBack: false\n                            };\n                            \n                            resolve(this._transactionScope.trx);\n                        }\n                    });\n                })\n                .catch(err => reject(err));\n        });\n        \n        return promise;\n    }\n    \n    public commit(): Promise<void>\n    {\n        if (!this._transactionScope)\n            return Promise.resolve();\n        \n        if (this._transactionScope.isCommitted || this._transactionScope.isRolledBack)\n            return Promise.reject(new InvalidOperationException(\"commiting completed UnitOfWork\"));    \n        \n        this._transactionScope.isCommitted = true;\n        let promise = new Promise<void>((resolve, reject) =>\n        {\n            this._transactionScope.trx.commit()\n                .then(() => resolve())\n                .catch((err) => reject(err));\n        });\n        \n        return promise;\n    }\n    \n    public rollback(): Promise<void>\n    {\n        if (!this._transactionScope)\n            return Promise.resolve();\n\n        if (this._transactionScope.isCommitted || this._transactionScope.isRolledBack)\n            return Promise.reject(new InvalidOperationException(\"rolling back completed UnitOfWork\"));\n\n        this._transactionScope.isRolledBack = true;\n        let promise = new Promise<void>((resolve, reject) =>\n        {\n            this._transactionScope.trx.rollback(\"[DELIBERATE]\")\n                .then(() => resolve())\n                .catch((err) => reject(err));\n        });\n\n        return promise;\n    }\n}\n\ninterface TransactionScope\n{\n    trx: Knex.Transaction;\n    isCommitted: boolean;\n    isRolledBack: boolean;\n}"]}